/*!
 * Created by qzm (qzmer1104@qq.com) on 2015/3/22.
 */
(function(t,i){if(typeof exports==="object"){module.exports=i()}else if(typeof define==="function"&&define.amd){define(i)}else if(typeof define==="function"&&define.cmd){define(i)}else{t.mgSelect=i()}})(this,function(require,exports,module){require("util");var t=require("jquery");var i=0,o,e,n,a=[],s,l,r,h,u,c={};o={optmpl:'<a href="javascript:void(0);" class="oc" data-label=\'{label}\' data-value="{value}" title="{title}">{text}</a>',currentClass:"current",itemClass:"oc",grayClass:"gray-c",noValue:"",noLabel:"",labelShowFormat:t.noop,labelFormat:t.noop,titleFormat:t.noop,textFormat:t.noop,name:"",disabled:false};s=function(t){a.forEach(function(i){if(t!=i){i.hideOption()}})};l={UP:38,DOWN:40,ENTER:13,BACK:8,TAB:9};r=function(){};h=function(){var t=this,i,o,e=t.setting.currentClass;i=!!t.$optionRoot.data("show");if(!i){t.$optionRoot.show().data("show",true);s(t)}else{o=t.$optionRoot.find("."+e);if(o.length){o.next().length&&o.removeClass(e).next().addClass(e)}else{t.$optionRoot.children(":first").addClass(e)}}};u={simple:{aClick:function(i){var o=i.data,e,n=this;e=t(n).data("value");e=e==undefined?"":""+e;o.val(e,true);o.hideOption()}},rich:{aClick:function(i){var o=i.data,e,n=this;e=t(n).data("value");e=e==undefined?"":""+e;o.val(e,true);o.hideOption()}}};function p(e,n){var a=++i;this.root=e;this.setting=t.extend({},o,n);this.getUUID=function(){return a};this._init()}p.prototype={_init:function(){if(!c[this.getUUID()]){e.call(this);a.push(this);c[this.getUUID()]=[]}},setup:function(t){var i=this,o="",e,n,a;t.forEach(function(t){e=i.setting.textFormat.call(i,t);n=i.setting.titleFormat.call(i,t);a=i.setting.labelFormat.call(i,t);o+=i.setting.optmpl.replace(/\{text\}/g,e).replace(/\{label\}/g,a).replace(/\{value\}/g,t.value).replace(/\{title\}/g,n)});this.$optionRoot.html(o);return this},addOption:function(t){var i=this,o="",e,n,a;t.forEach(function(t){e=i.setting.textFormat.call(i,t);n=i.setting.titleFormat.call(i,t);a=i.setting.labelFormat.call(i,t);o+=i.setting.optmpl.replace(/\{text\}/g,e).replace(/\{label\}/g,a).replace(/\{value\}/g,t.value).replace(/\{title\}/g,n)});this.$optionRoot.append(o);return this},val:function(i,o){var e=this,n,a;if(arguments.length){n=e.$optionRoot.find("."+e.setting.itemClass);n.each(function(){var n,s;s=t(this).data("value");s=s==undefined?"":s+"";n=s==i;t(this).toggleClass(e.setting.currentClass,n);if(n){a=e.$input.val();e.$input.val(i);e.$lable.html(i?e.setting.labelShowFormat.call(this):e.noLabel);!!o&&a!==i&&c[e.getUUID()].forEach(function(t){t.apply(e)})}});return this}return this.$input.val()||""},getSelectedIndex:function(){return this.$optionRoot.children("."+this.setting.currentClass).index()},valByIndex:function(t){var i=this.$optionRoot.children(":eq("+t+")");this.val(i.data("value"))},warn:function(){var t=this;return this},showOption:function(){this.$optionRoot.show().data("show",true);return this},hideOption:function(){this.$optionRoot.hide().data("show",false);return this},onchange:function(i){c[this.getUUID()].push(t.isFunction(i)&&i);return this},offchange:function(t){var i=-1;c[this.getUUID()].forEach(function(o,e){if(o==t){i=e}});c[this.getUUID()].splice(i,1);return this}};e=function(){var i=this,o=this.root;this.$input=t(o).find("input").attr("name",i.setting.name);i.$lable=t(o).find("div.input-ts");i.$optionRoot=t(o).find("p.input-option");i.$options=i.$optionRoot.find("a");i.noValue=i.setting.noValue||i.$input.val();i.noLabel=i.setting.noLabel||i.$lable.html();i.$lable.click(function(t){var o;o=!!i.$optionRoot.data("show");o?i.$optionRoot.hide().data("show",false):i.$optionRoot.show().data("show",true)});t(document).click(function(e){if(!t(e.target).closest(o).length){i.$optionRoot.hide().data("show",false)}});i.$optionRoot.on("click","a.oc",i,u.rich.aClick)};function f(e,n){var a=++i;this.root=e;this.setting=t.extend({},o,n);this.getUUID=function(){return a};this._init()}f.prototype={_init:function(){if(!c[this.getUUID()]){n.call(this);a.push(this);c[this.getUUID()]=[]}return this},setup:function(t){var i=this,o="";t.forEach(function(t){o+=i.setting.optmpl.replace(/\{text\}/g,t.text).replace(/\{value\}/g,t.value).replace(/\{title\}/g,t.title)});this.$optionRoot.html(o);return this},addOption:function(t){var i=this,o="";t.forEach(function(t){o+=i.setting.optmpl.replace(/\{text\}/g,t.text).replace(/\{value\}/g,t.value).replace(/\{title\}/g,t.title)});this.$optionRoot.append(o);return this},val:function(i,o){var e=this,n,a;if(arguments.length){n=e.$optionRoot.find("."+e.setting.itemClass);n.each(function(){var n,s;s=t(this).data("value");s=s==undefined?"":s+"";n=i==s;t(this).toggleClass(e.setting.currentClass,n);if(n){a=e.$input.val();e.$input.val(i);!!o&&a!=i&&c[e.getUUID()].forEach(function(t){t.apply(e)})}});return this}return this.$input.val()||""},showOption:function(){this.$optionRoot.show().data("show",true);return this},hideOption:function(){this.$optionRoot.hide().data("show",false);return this},onchange:function(i){c[this.getUUID()].push(t.isFunction(i)&&i);return this},offchange:function(t){var i=-1;c[this.getUUID()].forEach(function(o,e){if(o==t){i=e}});c[this.getUUID()].splice(i,1)}};n=function(){var i=this,o=this.root;this.$input=t(o).find("input").attr("name",i.setting.name);i.$optionRoot=t(o).find("p.input-option");i.$options=i.$optionRoot.find("a");i.noValue=i.setting.noValue||i.$input.val();if(!i.setting.disabled){i.$input.click(function(t){var o;o=!!i.$optionRoot.data("show");o?i.$optionRoot.hide().data("show",false):i.$optionRoot.show().data("show",true)}).keydown(function(o){var e,n,a=i.setting.currentClass;switch(o.which){case l.DOWN:break;case l.UP:break;case l.ENTER:if(i.$optionRoot.data("show")){var s=i.$optionRoot.find("."+i.setting.currentClass);s.length&&i.val(s.data("value"));o.preventDefault();o.stopPropagation()}break;case l.TAB:i.hideOption();break;case l.BACK:if(t(this).prop("readonly")){o.preventDefault();o.stopPropagation()}break;default:break}});t(document).click(function(e){if(!t(e.target).closest(o).length){i.$optionRoot.hide().data("show",false)}});i.$optionRoot.on("click","a.oc",i,u.simple.aClick)}};return{simple:f,rich:p}});