/*!
 * Created by qzm (qzmer1104@qq.com) on 2015/3/18.
 */
(function(e,t){if(typeof exports==="object"){module.exports=t()}else if(typeof define==="function"&&define.amd){define(t)}else if(typeof define==="function"&&define.cmd){define(t)}else{e.filter=t()}})(this,function(require,exports,module){require("jquery");require("util");var e={pageKey:"page",filterKey:"fp",keywordKey:"keyword",selectedClass:"selected",filterSelector:'a[data-filter="{key}"][data-id="{value}"]',itemSelector:"a[data-filter]",filterRootSelector:".mg-filter",filterRowSelector:".filter-row",filterRowSelectedSelector:".filter-row.selected",cancelSelector:"div.unlimited",singleItemSelector:"a",sortSelector:".sort-group",sortItemSelector:"a",wrapWidth:660,sortId:"312",minId:"310",maxId:"311",filterDict:{300:"产品玩法",301:"出发日期",302:"行程天数",303:"出发城市",304:"产品类型",305:"地区景点",306:"住宿类型",307:"产品主题",308:"交通工具",309:"目的地"},sortDict:{"list-f-312-1":{values:["0"],select:{0:{id:"",title:""}},notselect:{id:0,title:"推荐"}},"list-f-312-2":{values:["1"],select:{1:{id:"",title:""}},notselect:{id:1,title:"点击按销量从高到低排序"}},"list-f-312-3":{values:["5","6"],select:{5:{id:6,title:"点击按星级从低到高排序",clazz:"sort-down"},6:{id:5,title:"点击按星级从高到低排序",clazz:"sort-up"}},notselect:{id:5,title:"点击按星级从高到低排序",clazz:"sort-down"}},"list-f-312-4":{values:["3","4"],select:{3:{id:4,title:"点击按价格从低到高排序",clazz:"sort-down"},4:{id:3,title:"点击按价格从高到低排序",clazz:"sort-up"}},notselect:{id:4,title:"点击按价格从低到高排序",clazz:"sort-up"}}},showMoreSelector:"a.show-fold",moreOffTpl:'更多<i class="icon arr-down">&nbsp;</i>',moreOnTpl:'收起<i class="icon arr-up-blue">&nbsp;</i>',showMulSelector:".btn-double",nowrapName:"nowrap",mulScrollSelectorName:"filter-scrollbar",mulBtnBoxSelector:"div.filter-btnbox",mulAnyTpl:'<div class="unlimited">不限</div>',mulAchorTpl:'<a href="javascript:void(0);" title="{txt}" data-filter="{filter}" data-id="{id}" class="{selected}">{txt}</a>',mulCheckboxTpl:'<label title="{txt}"><input value="{id}" {checked} data-filter="{filter}" type="checkbox" class="input-c">{txt}</label>',showMoreItemI18n:{fold:"收起更多选项 ︽",unfold:"展开更多选项 ︾"},mulBtnConfirm:"a[data-confirm]",mulBtnCancel:"a[data-cancel]",moreRowBtn:"a.filter-more",crumbsTpl:'<a href="javascript:void(0);" title="{filterName}-{idName}" filter="{filter}">{filterName}-<span>{idName}</span><i class="icon close-x-yellow">&nbsp;</i></a>',clearAllBtn:"a.clear-all",crumbsFileItemsSelector:".filter-item",closexbtnSelector:".close-x-yellow",priceGroupSelector:".price-group",priceInputSelector:"input.input-sm",cityOpenSelector:".city-open",moreItemSelector:"a[data-more]",moreItemI18n:{up:'收起产品<i class="icon arr-up"></i>',down:'查看更多产品<i class="icon arr-down"></i>'},destIcoSelector:"#guide-address"},t={init:function(t){var l=$.extend({},e,t);if(!l.noResult){this.showFilter(l);this.addChooseEvent(l);this.addSortEvent(l);this.addShowMore(l);this.addMulSelect(l);this.addShowMoreRow(l);this.addCrumbs(l);this.addClearAllFilter(l);this.addMinMaxFilter(l);this.addCityOpenSelect(l);this.addItemShowMore(l)}this.addShowDestIco(l);this.initKeyword(l)},initKeyword:function(e){window.formSearchKeyWords&&$("#search input").val(window.formSearchKeyWords)},prepare:function(t,l){var i=$.extend({},e,l);$.isFunction(t)&&t.call(this,i)},paramFilter:function(e){var t,l={};e&&e.split(";").forEach(function(e){if(e){t=e.split(":");l[t[0]]=t[1]?t[1].split(","):[]}});return l},serilizeFilter:function(e){var t,l=[];for(t in e){l.push(t+":"+e[t].join(","))}return l.join(";")},changeQuery:function(e,t){var l,i,r=this;l=Util.bom.getQuery();i=this.paramFilter(l[e]);i=$.isFunction(t)&&t(i);i=r.serilizeFilter(i);l[e]=i;return l},jude2show:function(e,t){t.each(function(t){var l=this,i,r=$(l).find(e.itemSelector),o=0,a;r.each(function(){o+=$(this).outerWidth();if(o>e.wrapWidth){a=true}return!a});!a&&$(l).find(e.showMoreSelector).data("hidden",true).hide()})},showFilter:function(e){var t,l,i,r,o,a,n,c,s,d;$(e.filterRootSelector+" "+e.filterRowSelector).filter(function(e){e===4&&$(this).addClass("last");return e>4}).hide();$(e.showMulSelector).filter(function(){return!$(this).prev(e.itemSelector).length}).hide();t=Util.bom.getQuery(e.filterKey);if(!t){this.showSort(e,{});this.showMinMax(e,{});return}o=this.paramFilter(t);this.showSort(e,o);this.showMinMax(e,o);n="";$.each(o,function(t,r){c=[];l=false;if(!s&&[e.minId,e.maxId,e.sortId].indexOf(t)==-1&&r.length){s=t;$(e.filterRowSelectedSelector).show().prev().addClass("last")}r.forEach(function(r){a=$(e.filterSelector.replace(/\{key\}/g,t).replace(/\{value\}/g,r));a.addClass(e.selectedClass).length&&(l=true,i=a.parent(),c.push(a.attr("title")))});l&&i.children(":first").removeClass(e.selectedClass);l&&(n+=e.crumbsTpl.replace(/\{filter\}/g,t).replace(/\{filterName\}/g,e.filterDict[t]).replace(/\{idName\}/g,c.join("、")))});$(e.crumbsFileItemsSelector).children(":last").before(n)},showMinMax:function(e,t){var l,i,r;l=t[e.minId];i=t[e.maxId];r=$(e.priceGroupSelector).find(e.priceInputSelector);[l,i].forEach(function(e,t){e&&e[0]&&!r.eq(t).val()&&r.eq(t).val(e[0])})},showSort:function(e,t){var l,i,r,o,a,n;l=t[e.sortId];if(!l||!l[0]||isNaN(l[0])){l=["0"]}for(i in e.sortDict){r=e.sortDict[i];n=r.values.indexOf(l[0])>-1;a=n?r.select[l[0]]:r.notselect;$("#"+i).toggleClass("select",n).attr({title:a.title,"data-id":a.id}).find("i").removeClass().addClass("icon "+a.clazz)}},addChooseEvent:function(e){var t=this;$(e.filterRootSelector).on("click",e.itemSelector,function(){var l,i=this;l=t.changeQuery(e.filterKey,function(e){var t=$(i).data();t&&(e[t.filter]=[t.id]);return e});delete l[e.pageKey];Util.bom.locatedTo(l)});$(e.filterRootSelector).on("click",e.cancelSelector,function(){var l,i=this;if(!$(i).hasClass(e.selectedClass)){l=t.changeQuery(e.filterKey,function(t){var l=$(i).next(e.singleItemSelector).data();l&&delete t[l.filter];return t});delete l[e.pageKey];Util.bom.locatedTo(l)}})},addSortEvent:function(e){var t=this;$(e.sortSelector).on("click",e.sortItemSelector,function(){var l,i,r=this;i=$(r).data("id");if(!isNaN(parseInt(i,10))){l=t.changeQuery(e.filterKey,function(t){t[e.sortId]=[i];return t});delete l[e.pageKey];Util.bom.locatedTo(l)}})},addShowMore:function(e){var t=this;$(e.filterRootSelector).on("click",e.showMoreSelector,function(t){var l=this,i;i=!$(l).data("on");$(l).data("on",i).toggleClass("on",i).parent().toggleClass(e.mulScrollSelectorName,i).toggleClass(e.nowrapName,!i).parent().toggleClass(e.nowrapName,!i);$(l).html(i?e.moreOnTpl:e.moreOffTpl)})},addMulSelect:function(e){var t=this;$(e.filterRootSelector).on("click",e.showMulSelector,function(){var t=this,l,i,r;l=$(t).hide().next().hide().parent();i=l.find(e.itemSelector);r="";i.each(function(t,l){var i=$(l).hasClass(e.selectedClass)?"checked":"";r+=e.mulCheckboxTpl.replace(/\{txt\}/g,$(l).attr("title")).replace(/\{id\}/g,$(l).data("id")).replace(/\{filter\}/g,$(l).data("filter")).replace(/\{checked\}/g,i)}).replaceWith("");l.addClass(e.mulScrollSelectorName).removeClass(e.nowrapName).children(":first").hide().after(r);l.next(e.mulBtnBoxSelector).show().parent().removeClass(e.nowrapName)});$(e.filterRootSelector).on("click",e.mulBtnConfirm,function(){var l,i=[],r=this;$(r).parent().prev().find("input").each(function(){$(this).prop("checked")&&i.push(this.value)});l=t.changeQuery(e.filterKey,function(e){var t=$(r).data("confirm");t&&(e[t]=i);return e});delete l[e.pageKey];Util.bom.locatedTo(l)});$(e.filterRootSelector).on("click",e.mulBtnCancel,function(){var l,i,r,o,a=this,n,c="";i=$(a).data("cancel");l=Util.bom.getQuery(e.filterKey);l=t.paramFilter(l)[i];r=$(a).parent().hide().prev().show();o=r.find("input").each(function(){var t=l&&l.indexOf(this.value)>-1?e.selectedClass:"";c+=e.mulAchorTpl.replace(/\{txt\}/g,$(this).parent().attr("title")).replace(/\{filter\}/g,$(this).data("filter")).replace(/\{id\}/g,this.value).replace(/\{selected\}/g,t)});r.find("label").replaceWith("");r.children(":first").show().after(c);n=r.find(e.showMulSelector).show();!n.next().data("hidden")&&n.next().show();if(!n.next().data("on")){r.removeClass(e.mulScrollSelectorName).addClass(e.nowrapName).parent().addClass(e.nowrapName)}})},addShowMoreRow:function(e){var t=this;$(e.moreRowBtn).click(function(){var t,l;l=$(this).data("unfold");t=$(e.filterRootSelector+" "+e.filterRowSelector);if(l){t.filter(function(e){e===4&&$(this).addClass("last");return e>4&&e!=t.length-1}).hide();$(this).data("unfold",false).text(e.showMoreItemI18n.unfold)}else{t.removeClass("last").filter(function(e){return e!=t.length-1}).show().last().addClass("last");$(this).data("unfold",true).text(e.showMoreItemI18n.fold);if(l==undefined){}}})},addCrumbs:function(e){var t=this;$(e.crumbsFileItemsSelector).on("click",e.closexbtnSelector,function(){var l,i=this;l=t.changeQuery(e.filterKey,function(e){var t=$(i).parent().attr("filter");t&&delete e[t];return e});delete l[e.pageKey];Util.bom.locatedTo(l)})},addClearAllFilter:function(e){var t=this;$(e.clearAllBtn).click(function(){var t=Util.bom.getQuery();delete t[e.filterKey];delete t[e.pageKey];Util.bom.locatedTo(t)})},addMinMaxFilter:function(e){var t=this,l;l=function(){var e=this.value,t;while(!/^\d*$/.test(e)){e=e.substr(0,e.length-1);!t&&(t=true)}t&&(this.value=e)},showConfirm=function(){$(this).parent().addClass(e.selectedClass)},hideConfirm=function(){$(this).removeClass(e.selectedClass)},$(e.priceGroupSelector+" "+e.priceInputSelector).on("input propertychange",l).on("focus",showConfirm).on("keydown",function(e){e.which===13&&$("a[data-pgconfirm]").trigger("click")});$(document).click(function(t){if(!$(t.target).closest(e.priceGroupSelector).length){hideConfirm.call($(e.priceGroupSelector)[0])}});$("a[data-pgclear]").click(function(){$(this).parents(e.priceGroupSelector).find(e.priceInputSelector).val("")});$("a[data-pgconfirm]").click(function(){var l,i,r,o;o=$(this).parents(e.priceGroupSelector).find(e.priceInputSelector);i=+o.eq(0).val(),r=+o.eq(1).val();if(i&&r&&i>r){i^=r;r^=i;i^=r}l=t.changeQuery(e.filterKey,function(t){i?(o.eq(0).val(i),t[e.minId]=[i]):delete t[e.minId];r?(o.eq(1).val(r),t[e.maxId]=[r]):delete t[e.maxId];return t});delete l[e.pageKey];Util.bom.locatedTo(l)})},addCityOpenSelect:function(e){var t=this;$(e.cityOpenSelector).on("click","dd a",function(){var t;t=Util.bom.getQuery();t[e.keywordKey]=encodeURIComponent($(this).attr("title"));delete t[e.filterKey];delete t[e.pageKey];Util.bom.locatedTo(t)})},addItemShowMore:function(e){$(e.moreItemSelector).click(function(t){var l=$(this),i=l.parent().parent(),r,o=true;r=i.find("[data-hide]");r.slideToggle({queue:false,duration:500,start:function(){if(o){o=false;var t=l.data("show");l.html(!t?e.moreItemI18n.up:($("html,body").animate({scrollTop:i.offset().top},{easing:"linear",queue:false}),e.moreItemI18n.down)).data("show",!t)}}});t.preventDefault()})},addShowDestIco:function(e){$(e.destIcoSelector+" a").each(function(){var e=this,t={url:$(e).attr("href")};$.getJSON(baseConfig.base+baseConfig.list_req_url,t).done(function(t){t&&t.code===200&&$(e).parent().removeClass("hide")})})}};return t});