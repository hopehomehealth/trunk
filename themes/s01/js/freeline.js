/*!
 * Created by qzm (qzmer1104@qq.com) on 2015/3/21.
 */
define(function(require,exports,module){require("util");var e=require("jquery"),t=require("cal4pro"),a;function o(e){var t=[],a,o=new Date,l,r;l=[o.getFullYear(),o.getMonth()+1,o.getDate()].join("-").replace(/\b(\w)\b/g,"0$1");for(a in e){if(a!="id"){if(a<l){delete e[a];continue}!r&&(r=a);r>a&&(r=a)}}return r||l}var l={rootSelector:".lv-list",selector:"a.remore",remoteUrl:baseConfig.base+baseConfig.tour_calc_price_url,remoteGetData:e.noop,holiday:a,cal4proBuildLink:e.noop},r={addRemoteEvent:function(a){var r,i=e.extend({},l,a);i.url=i.remoteUrl;i.getData=i.remoteGetData;i.url=i.url.indexOf("#")>-1?i.url.substring(0,i.url.indexOf("#")):i.url;e(i.rootSelector).on("click",i.selector,function(a){var l=this,r,n,c,f;r=e(l).data("on");f="J_calc_"+e(l).data("id");if(!r){if(r===undefined){n=e.isFunction(i.getData)&&i.getData.call(l);e.ajax({url:i.url,type:"GET",cache:true,data:n,dataType:"jsonp",jsonp:"callBack",jsonpCallback:"__pr_mg_cache__"}).done(function(a){var r,n,c,d,s;r=t({startDate:o(a),proInfo:a,holiday:i.holiday,buildLink:i.cal4proBuildLink});n=r.width()/2;d=5+e(l).outerHeight()+e(l).offset().top;s=e(l).prev().offset().left;e("body").append(r.attr("id",f).css({position:"absolute",zIndex:1,top:d,left:s}));[["#pro-calc-today","list-calc-today"],["#pro-calc-next","list-calc-next"],["#pro-calc-prev","list-calc-prev"]].forEach(function(e){r.find(e[0]).attr("id",e[1])});e(document).click(function(t){if(t.target!=l&&!e(t.target).closest(r).length){e(l).data("on",false);e("#"+f).hide()}});e(window).resize(function(){var t=e("#"+f);t.is(":visible")&&t.css({top:5+e(l).offset().top+e(l).outerHeight(),left:e(l).prev().offset().left})})}).fail(function(){alert("服务器繁忙，请稍后访问！")})}else{e("#"+f).show()}e(l).data("on",true)}else{e(l).data("on",false);e("#"+f).hide()}a.preventDefault()})}};module.exports=r});